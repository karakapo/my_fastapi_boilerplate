# Testing Guide

## Test Yapısı

```
tests/
├── unit/                    # Unit tests (isolated, mocked)
│   ├── test_cache_service.py
│   ├── test_user_service.py
│   └── test_email_service.py
├── integration/             # Integration tests (with real services)
│   ├── test_auth_routes.py
│   ├── test_users_routes.py
│   └── test_posts_routes.py
└── conftest.py             # Shared fixtures
```

---

## Unit Tests

### Service Test Örneği

```python
# tests/unit/test_user_service.py
import pytest
from unittest.mock import AsyncMock, MagicMock
from app.services.user_service import UserService
from app.services.cache_service import CacheService
from app.models.user import UserResponse, UserUpdate
from app.exceptions.base import UserNotFoundException

@pytest.mark.asyncio
async def test_get_user_from_cache(mock_redis):
    """Test getting user from cache."""
    # Arrange
    cache = CacheService(mock_redis)
    mock_supabase = MagicMock()
    user_service = UserService(mock_supabase, cache)

    cached_user = {
        "id": "123",
        "email": "test@example.com",
        "created_at": "2024-01-01T00:00:00Z"
    }
    mock_redis.get.return_value = json.dumps(cached_user)

    # Act
    result = await user_service.get_user_by_id("123")

    # Assert
    assert isinstance(result, UserResponse)
    assert result.id == "123"
    assert result.email == "test@example.com"
    mock_redis.get.assert_called_once_with("user:123")
    mock_supabase.auth.admin.get_user_by_id.assert_not_called()


@pytest.mark.asyncio
async def test_get_user_cache_miss(mock_redis, mock_supabase):
    """Test getting user when cache misses."""
    # Arrange
    cache = CacheService(mock_redis)
    user_service = UserService(mock_supabase, cache)

    # Cache miss
    mock_redis.get.return_value = None

    # Database response
    mock_user = MagicMock()
    mock_user.id = "123"
    mock_user.email = "test@example.com"
    mock_user.created_at = "2024-01-01T00:00:00Z"

    mock_supabase.auth.admin.get_user_by_id.return_value = MagicMock(user=mock_user)

    # Act
    result = await user_service.get_user_by_id("123")

    # Assert
    assert result.id == "123"
    mock_redis.get.assert_called_once()
    mock_supabase.auth.admin.get_user_by_id.assert_called_once_with("123")
    mock_redis.setex.assert_called_once()  # Should cache result


@pytest.mark.asyncio
async def test_get_user_not_found(mock_redis, mock_supabase):
    """Test getting non-existent user."""
    # Arrange
    cache = CacheService(mock_redis)
    user_service = UserService(mock_supabase, cache)

    mock_redis.get.return_value = None
    mock_supabase.auth.admin.get_user_by_id.return_value = MagicMock(user=None)

    # Act & Assert
    with pytest.raises(UserNotFoundException) as exc:
        await user_service.get_user_by_id("999")

    assert "999" in str(exc.value)


@pytest.mark.asyncio
async def test_update_user_invalidates_cache(mock_redis, mock_supabase):
    """Test that updating user invalidates cache."""
    # Arrange
    cache = CacheService(mock_redis)
    user_service = UserService(mock_supabase, cache)

    user_update = UserUpdate(email="newemail@example.com")

    # Act
    await user_service.update_user("123", user_update)

    # Assert
    mock_redis.delete.assert_called_with("user:123")
```

---

### Cache Service Test

```python
# tests/unit/test_cache_service.py
import pytest
import json
from app.services.cache_service import CacheService

@pytest.mark.asyncio
async def test_cache_set_get(mock_redis):
    """Test basic cache set and get."""
    cache = CacheService(mock_redis)

    # Setup mock
    test_data = {"name": "test", "value": 123}
    mock_redis.get.return_value = json.dumps(test_data)

    # Set
    await cache.set("test_key", test_data, ttl=60)

    # Get
    result = await cache.get("test_key")

    # Assert
    assert result == test_data
    mock_redis.setex.assert_called_once_with(
        "test_key",
        60,
        json.dumps(test_data)
    )


@pytest.mark.asyncio
async def test_cache_delete(mock_redis):
    """Test cache delete."""
    cache = CacheService(mock_redis)

    await cache.delete("test_key")

    mock_redis.delete.assert_called_once_with("test_key")


@pytest.mark.asyncio
async def test_cache_invalidate_pattern(mock_redis):
    """Test pattern-based cache invalidation."""
    cache = CacheService(mock_redis)

    # Mock scan to return keys
    mock_redis.scan.return_value = (0, ["user:123:posts", "user:123:profile"])
    mock_redis.delete.return_value = 2

    result = await cache.invalidate_pattern("user:123:*")

    assert result == 2
    mock_redis.delete.assert_called_once()
```

---

## Integration Tests

### Route Test Örneği

```python
# tests/integration/test_users_routes.py
import pytest
from fastapi.testclient import TestClient
from app.main import app

def test_get_current_user(client, auth_headers, mock_user_data):
    """Test getting current user info."""
    response = client.get(
        "/api/v1/users/me",
        headers=auth_headers
    )

    assert response.status_code == 200
    data = response.json()

    assert data["success"] is True
    assert "email" in data["data"]
    assert data["data"]["email"] == mock_user_data["email"]


def test_get_user_by_id(client, auth_headers):
    """Test getting user by ID."""
    user_id = "test-user-id"

    response = client.get(
        f"/api/v1/users/{user_id}",
        headers=auth_headers
    )

    assert response.status_code == 200
    data = response.json()

    assert data["success"] is True
    assert data["data"]["id"] == user_id


def test_get_user_unauthorized(client):
    """Test getting user without authentication."""
    response = client.get("/api/v1/users/me")

    assert response.status_code == 401


def test_update_user(client, auth_headers):
    """Test updating user."""
    user_id = "test-user-id"
    update_data = {
        "email": "newemail@example.com"
    }

    response = client.put(
        f"/api/v1/users/{user_id}",
        headers=auth_headers,
        json=update_data
    )

    assert response.status_code == 200
    data = response.json()

    assert data["success"] is True
    assert data["data"]["user"]["email"] == update_data["email"]


def test_update_other_user_forbidden(client, auth_headers):
    """Test that user cannot update other user's profile."""
    other_user_id = "other-user-id"

    response = client.put(
        f"/api/v1/users/{other_user_id}",
        headers=auth_headers,
        json={"email": "new@example.com"}
    )

    assert response.status_code == 403


def test_validation_error(client, auth_headers):
    """Test validation error response."""
    response = client.put(
        "/api/v1/users/123",
        headers=auth_headers,
        json={
            "email": "invalid-email"  # Invalid email format
        }
    )

    assert response.status_code == 422
    data = response.json()

    assert data["success"] is False
    assert data["error"]["code"] == "VALIDATION_ERROR"
```

---

### Auth Routes Test

```python
# tests/integration/test_auth_routes.py
def test_signup(client):
    """Test user signup."""
    signup_data = {
        "email": "newuser@example.com",
        "password": "SecurePass123"
    }

    response = client.post(
        "/api/v1/auth/signup",
        json=signup_data
    )

    assert response.status_code == 201
    data = response.json()

    assert data["success"] is True
    assert "user" in data["data"]
    assert data["data"]["user"]["email"] == signup_data["email"]


def test_login(client):
    """Test user login."""
    login_data = {
        "email": "test@example.com",
        "password": "password123"
    }

    response = client.post(
        "/api/v1/auth/login",
        json=login_data
    )

    assert response.status_code == 200
    data = response.json()

    assert data["success"] is True
    assert "access_token" in data["data"]
    assert "refresh_token" in data["data"]


def test_login_invalid_credentials(client):
    """Test login with invalid credentials."""
    response = client.post(
        "/api/v1/auth/login",
        json={
            "email": "test@example.com",
            "password": "wrongpassword"
        }
    )

    assert response.status_code == 401
```

---

## Fixtures (conftest.py)

```python
# tests/conftest.py
import pytest
from fastapi.testclient import TestClient
from unittest.mock import AsyncMock, MagicMock
import redis.asyncio as redis
from app.main import app
from app.core.redis import get_redis
from app.core.supabase import get_supabase

@pytest.fixture
def mock_redis() -> AsyncMock:
    """Mock Redis client."""
    mock = AsyncMock(spec=redis.Redis)
    mock.get.return_value = None
    mock.set.return_value = True
    mock.setex.return_value = True
    mock.delete.return_value = 1
    mock.ping.return_value = True
    return mock


@pytest.fixture
def mock_supabase() -> MagicMock:
    """Mock Supabase client."""
    mock = MagicMock()

    # Mock auth operations
    mock.auth.sign_up.return_value = MagicMock(
        user=MagicMock(
            id="test-user-id",
            email="test@example.com"
        )
    )

    return mock


@pytest.fixture
def client(mock_redis, mock_supabase) -> TestClient:
    """FastAPI test client with mocked dependencies."""
    app.dependency_overrides[get_redis] = lambda: mock_redis
    app.dependency_overrides[get_supabase] = lambda: mock_supabase

    with TestClient(app) as test_client:
        yield test_client

    app.dependency_overrides.clear()


@pytest.fixture
def auth_headers() -> dict:
    """Authentication headers."""
    return {
        "Authorization": "Bearer test-access-token"
    }


@pytest.fixture
def mock_user_data() -> dict:
    """Mock user data."""
    return {
        "id": "test-user-id",
        "email": "test@example.com",
        "created_at": "2024-01-01T00:00:00Z"
    }
```

---

## Celery Task Tests

```python
# tests/unit/test_email_tasks.py
import pytest
from unittest.mock import patch, MagicMock
from app.tasks.email_tasks import send_welcome_email

def test_send_welcome_email_success():
    """Test successful email sending."""
    with patch('app.tasks.email_tasks.EmailService') as mock_email:
        mock_email.return_value.send_welcome_email.return_value = True

        result = send_welcome_email("test@example.com", "Test User")

        assert result["status"] == "success"
        assert result["email"] == "test@example.com"


def test_send_welcome_email_retry():
    """Test email task retry on failure."""
    with patch('app.tasks.email_tasks.EmailService') as mock_email:
        # First call fails, second succeeds
        mock_email.return_value.send_welcome_email.side_effect = [
            Exception("SMTP error"),
            True
        ]

        # Should retry
        with pytest.raises(Exception):
            send_welcome_email("test@example.com", "Test User")
```

---

## Running Tests

### Run All Tests
```bash
pytest
```

### Run with Coverage
```bash
pytest --cov=app tests/
```

### Run Specific Test File
```bash
pytest tests/unit/test_cache_service.py
```

### Run Specific Test
```bash
pytest tests/unit/test_cache_service.py::test_cache_set_get
```

### Run with Verbose Output
```bash
pytest -v
```

### Run Only Unit Tests
```bash
pytest tests/unit/
```

### Run Only Integration Tests
```bash
pytest tests/integration/
```

---

## Test Best Practices

### 1. AAA Pattern (Arrange, Act, Assert)
```python
@pytest.mark.asyncio
async def test_get_user():
    # Arrange - Setup test data
    cache = CacheService(mock_redis)
    user_id = "123"

    # Act - Execute function
    result = await cache.get(f"user:{user_id}")

    # Assert - Verify results
    assert result is not None
```

### 2. One Assert Per Test (İdeal)
```python
# ✅ DOĞRU - Tek bir şeyi test et
def test_user_email():
    user = create_user()
    assert user.email == "test@example.com"

def test_user_id():
    user = create_user()
    assert user.id is not None

# ❌ YANLIŞ - Birden fazla assert (bazen gerekli olabilir)
def test_user():
    user = create_user()
    assert user.email == "test@example.com"
    assert user.id is not None
    assert user.created_at is not None
```

### 3. Descriptive Test Names
```python
# ✅ DOĞRU
def test_get_user_returns_cached_data_when_available():
    pass

# ❌ YANLIŞ
def test_user():
    pass
```

### 4. Mock External Dependencies
```python
# ✅ DOĞRU - Mock external service
@patch('app.services.email_service.EmailService.send')
def test_send_email(mock_send):
    mock_send.return_value = True
    result = send_email()
    assert result is True

# ❌ YANLIŞ - Gerçek email gönderir
def test_send_email():
    result = send_email()  # Real email sent!
    assert result is True
```

### 5. Test Isolation
```python
# ✅ DOĞRU - Her test bağımsız
@pytest.fixture(autouse=True)
async def cleanup():
    yield
    await cache.clear()  # Cleanup after each test

# ❌ YANLIŞ - Test'ler birbirine bağımlı
def test_create_user():
    global user
    user = create_user()

def test_update_user():
    update_user(user)  # Depends on previous test
```

---

## CI/CD Integration

### GitHub Actions Example
```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest --cov=app tests/

      - name: Upload coverage
        uses: codecov/codecov-action@v2
```
